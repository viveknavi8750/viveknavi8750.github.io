<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>PG Tenant Manager â€” Final</title>
<style>
  :root{ --accent:#0a84ff; --muted:#6b7280; }
  body{ margin:0; font-family:Inter,Arial,sans-serif; background:#f3f4f6; color:#0f172a; }
  .container{ display:flex; min-height:100vh; }
  .sidebar{ width:220px; background:#111827; color:#fff; padding:18px; display:flex; flex-direction:column; gap:8px; }
  .sidebar button{ background:transparent; color:inherit; border:none; padding:10px; text-align:left; border-radius:8px; cursor:pointer; }
  .sidebar button.active{ background:#0b1220; }
  .main{ flex:1; padding:20px; }
  .card{ background:#fff; padding:16px; border-radius:10px; box-shadow:0 6px 18px rgba(15,23,42,0.06); margin-bottom:16px; }
  .row{ display:grid; grid-template-columns:repeat(2,1fr); gap:12px; }
  label{ display:block; margin-bottom:6px; color:var(--muted); font-size:13px; }
  input,select{ width:100%; padding:10px; border:1px solid #e6e7eb; border-radius:8px; background:#fff; }
  .btn{ background:var(--accent); color:#fff; padding:10px 14px; border-radius:8px; border:none; cursor:pointer; }
  .item{ display:flex; justify-content:space-between; align-items:center; padding:12px; border-radius:8px; background:#f9fafb; border:1px solid #e5e7eb; margin-bottom:10px; }
  .small-btn{ padding:6px 10px; border:none; border-radius:8px; cursor:pointer; margin-left:6px; font-size:13px; }
  .edit{ background:#059669; color:#fff; } .remove{ background:#ef4444; color:#fff; } .undo{ background:#6b7280; color:#fff; }
  .pagination button{ padding:6px 10px; margin:2px; border-radius:6px; border:1px solid #e6e7eb; background:#fff; cursor:pointer; }
  .pagination button.active{ background:var(--accent); color:#fff; }
  @media(max-width:900px){ .row{ grid-template-columns:1fr; } .sidebar{ display:none; } }
</style>
</head>
<body>
<div class="container">
  <aside class="sidebar">
    <h3 style="margin:0 0 6px 0">PG Manager</h3>
    <button id="nav-dashboard" onclick="showSection('dashboard')" class="active">ðŸ“Š Dashboard</button>
    <button id="nav-add" onclick="showSection('add')">âž• Add Tenant</button>
    <button id="nav-list" onclick="showSection('list')">ðŸ‘¥ Show Tenants</button>
    <div style="margin-top:auto; font-size:12px; color:#9ca3af">Rooms: 101-106, 201-206, â€¦ 601-603</div>
  </aside>

  <main class="main">
    <section id="section-dashboard" class="card">
      <h2 style="margin:0 0 12px 0">Dashboard</h2>
      <div id="dashboardContent">Loading...</div>
    </section>

    <section id="section-add" class="card" style="display:none">
      <h2 id="formTitle" style="margin:0 0 12px 0">âž• Add Tenant</h2>
      <form id="tenantForm" autocomplete="off">
        <input type="hidden" id="editId" value="">
        <div class="row">
          <div>
            <label for="name">Name</label>
            <input id="name" type="text" required />
          </div>
          <div>
            <label for="phone">Phone</label>
            <input id="phone" type="text" required />
          </div>

          <div>
            <label for="moveIn">Move-in</label>
            <input id="moveIn" type="date" />
          </div>
          <div>
            <label for="moveOut">Move-out</label>
            <input id="moveOut" type="date" />
          </div>

          <div>
            <label for="rent">Monthly Rent</label>
            <input id="rent" type="number" />
          </div>
          <div>
            <label for="rentStatus">Rent Status</label>
            <select id="rentStatus"><option>Pending</option><option>Paid</option></select>
          </div>

          <div>
            <label for="room">Room</label>
            <select id="room" required></select>
          </div>
          <div>
            <label for="bed">Bed (1-4)</label>
            <select id="bed" required><option value="">Select</option><option>1</option><option>2</option><option>3</option><option>4</option></select>
          </div>
        </div>

        <div style="margin-top:12px; display:flex; gap:8px; align-items:center;">
          <button class="btn" type="submit" id="saveBtn">Save Tenant</button>
          <button type="button" id="clearBtn" style="background:#f3f4f6;border:1px solid #e6e7eb;padding:10px;border-radius:8px">Clear</button>
          <div id="formMsg" style="margin-left:12px;color:#065f46"></div>
        </div>
      </form>
    </section>

    <section id="section-list" class="card" style="display:none">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
        <h2 style="margin:0">Tenants</h2>
        <div style="display:flex;gap:10px;align-items:center">
          <input id="search" placeholder="Search name/phone/room" style="padding:8px;border-radius:8px;border:1px solid #e6e7eb" />
          <select id="filterRoom" style="padding:8px;border-radius:8px;border:1px solid #e6e7eb"><option value="">All Rooms</option></select>
        </div>
      </div>

      <div id="tenantList"></div>
      <div id="pagination" class="pagination" style="margin-top:12px"></div>
    </section>
  </main>
</div>

<script>
/* ====== CONFIG: replace with your deployed Apps Script web app URL ====== */
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyeYacsS876b0w1-pytYjPgo7XUAfsnLpkFoFgmPiOQDX0KunscC0ts5O57cUIDQ3zStA/exec";
/* ====================================================================== */

const ROOMS = ['101','102','103','104','105','106','201','202','203','204','205','206','301','302','303','304','305','306','401','402','403','404','405','406','501','502','503','504','505','506','601','602','603'];

let tenantData = []; // normalized
let currentPage = 1;
const itemsPerPage = 6;
let isSubmitting = false;

/* DOM refs */
const navDashboard = document.getElementById('nav-dashboard');
const navAdd = document.getElementById('nav-add');
const navList = document.getElementById('nav-list');

const sectionDashboard = document.getElementById('section-dashboard');
const sectionAdd = document.getElementById('section-add');
const sectionList = document.getElementById('section-list');

const tenantForm = document.getElementById('tenantForm');
const editIdInput = document.getElementById('editId');
const formTitle = document.getElementById('formTitle');
const formMsg = document.getElementById('formMsg');
const saveBtn = document.getElementById('saveBtn');
const clearBtn = document.getElementById('clearBtn');

const searchInput = document.getElementById('search');
const filterRoom = document.getElementById('filterRoom');
const tenantListEl = document.getElementById('tenantList');
const paginationEl = document.getElementById('pagination');

/* init rooms */
function initRooms(){
  const roomSelect = document.getElementById('room');
  roomSelect.innerHTML = '<option value="">Select Room</option>';
  ROOMS.forEach(r => roomSelect.innerHTML += `<option value="${r}">${r}</option>`);
  filterRoom.innerHTML = '<option value="">All Rooms</option>';
  ROOMS.forEach(r => filterRoom.innerHTML += `<option value="${r}">${r}</option>`);
}
initRooms();

/* navigation */
function clearNav(){ navDashboard.classList.remove('active'); navAdd.classList.remove('active'); navList.classList.remove('active'); }
function showSection(which){
  clearNav();
  sectionDashboard.style.display = 'none';
  sectionAdd.style.display = 'none';
  sectionList.style.display = 'none';

  if(which === 'dashboard'){ navDashboard.classList.add('active'); sectionDashboard.style.display = 'block'; loadDashboard(); }
  else if(which === 'add'){ navAdd.classList.add('active'); sectionAdd.style.display = 'block'; resetForm(); }
  else { navList.classList.add('active'); sectionList.style.display = 'block'; loadTenants(); }
}
showSection('dashboard');

/* fetch wrapper */
async function apiFetch(action, opts = {}) {
  const url = `${SCRIPT_URL}?action=${action}`;
  const finalOpts = Object.assign({}, opts);
  if(finalOpts.body && typeof finalOpts.body === 'object'){
    finalOpts.headers = Object.assign({}, finalOpts.headers || {}, {'Content-Type':'application/json'});
    finalOpts.body = JSON.stringify(finalOpts.body);
  }
  const res = await fetch(url, finalOpts);
  if(!res.ok) throw new Error('Network error ' + res.status);
  const text = await res.text();
  try { return JSON.parse(text); } catch(e) { return text; }
}

/* Dashboard */
async function loadDashboard(){
  document.getElementById('dashboardContent').textContent = 'Loading...';
  try{
    const data = await apiFetch('dashboard', { method:'GET' });
    console.log('dashboard:', data);
    const floors = data.floors || {};
    const rooms = data.rooms || {};
    const rentStatus = data.rentStatus || { Paid:0, Pending:0 };
    const total = Object.values(floors).reduce((a,b)=>a+b,0) || 0;
    document.getElementById('dashboardContent').innerHTML = `
      <div style="display:flex;gap:12px;flex-wrap:wrap">
        <div class="card" style="flex:1;text-align:center"><div style="font-size:28px;font-weight:700">${total}</div><div>Total tenants</div></div>
        <div class="card" style="flex:1;text-align:center"><div style="font-size:22px;font-weight:700">${rentStatus.Paid||0}</div><div>Rent Paid</div></div>
        <div class="card" style="flex:1;text-align:center"><div style="font-size:22px;font-weight:700">${rentStatus.Pending||0}</div><div>Rent Pending</div></div>
      </div>
    `;
  } catch(err){
    console.error('loadDashboard error', err);
    document.getElementById('dashboardContent').textContent = 'Failed to load dashboard.';
  }
}

/* Load tenants */
async function loadTenants(){
  try{
    console.log('Fetching tenants...');
    const data = await apiFetch('list', { method:'GET' });
    console.log('RAW tenants response:', data);

    // normalize server array -> tenantData
    if(!Array.isArray(data)) {
      // if server returns object wrapper
      tenantData = Array.isArray(data.items) ? data.items : [];
    } else {
      tenantData = data;
    }

    // Normalization: prefer server-provided id (RowId or id), fallback to row
    tenantData = tenantData.map(r => {
      // possible keys: r.id, r.row, r.RowId, r.rowId
      const id = (r.id || r.id === 0) ? String(r.id) : ((r.row || r.row === 0) ? String(r.row) : (r.RowId||r.rowId ? String(r.RowId||r.rowId) : ''));
      return {
        id: id,
        rowNum: r.row || null,
        name: r.name || r.Name || '',
        phone: r.phone || r.Phone || '',
        moveIn: r.moveIn || r.MoveIn || r.movein || '',
        moveOut: r.moveOut || r.MoveOut || r.moveout || '',
        rent: r.rent || r.Rent || '',
        rentStatus: r.rentStatus || r.RentStatus || 'Pending',
        bed: String(r.bed || r.Bed || '').trim(),
        room: String(r.room || r.Room || '').trim(),
        // support status column names if present
        status: (r.Status || r.status || r.IsDeleted || r.isDeleted || r.statusText) || ''
      };
    });

    currentPage = 1;
    renderTenantList();
    populateFilterRoom();
  } catch(err){
    console.error('loadTenants error', err);
    tenantListEl.innerHTML = '<div style="color:#b91c1c">Failed to load tenants â€” check SCRIPT_URL/deployment.</div>';
  }
}

/* Render list */
function renderTenantList(){
  try{
    const q = (searchInput.value || '').trim().toLowerCase();
    const froom = filterRoom.value || '';

    let list = tenantData.slice();
    if(froom) list = list.filter(t => t.room === froom);
    if(q) list = list.filter(t => (t.name||'').toLowerCase().includes(q) || (t.phone||'').toLowerCase().includes(q) || (t.room||'').includes(q));

    const total = list.length;
    const pages = Math.max(1, Math.ceil(total / itemsPerPage));
    if(currentPage > pages) currentPage = pages;
    const start = (currentPage - 1) * itemsPerPage;
    const pageData = list.slice(start, start + itemsPerPage);

    tenantListEl.innerHTML = '';
    if(pageData.length === 0) {
      tenantListEl.innerHTML = '<div style="padding:12px;color:#6b7280">No tenants found</div>';
    } else {
      pageData.forEach(t => {
        // show undo only if backend supports status and row is deleted (e.g. "Deleted")
        const showUndo = t.status && String(t.status).toLowerCase().includes('deleted');
        const rowHtml = document.createElement('div');
        rowHtml.className = 'item';
        rowHtml.innerHTML = `
          <div>
            <strong>${escapeHtml(t.name)}</strong><br>
            ${escapeHtml(t.phone)} â€¢ Room ${escapeHtml(t.room)} â€¢ Bed ${escapeHtml(t.bed)} â€¢ ${escapeHtml(t.rentStatus)}
          </div>
          <div>
            <button class="small-btn edit" onclick="startEdit('${t.id}')">Edit</button>
            <button class="small-btn remove" onclick="softDelete('${t.id}')">Delete</button>
            ${ showUndo ? `<button class="small-btn undo" onclick="restoreTenant('${t.id}')">Undo</button>` : '' }
          </div>
        `;
        tenantListEl.appendChild(rowHtml);
      });
    }

    // pagination
    paginationEl.innerHTML = '';
    for(let i=1;i<=pages;i++){
      const b = document.createElement('button');
      b.textContent = i;
      if(i === currentPage) b.classList.add('active');
      b.onclick = ()=>{ currentPage = i; renderTenantList(); };
      paginationEl.appendChild(b);
    }
  } catch(err){
    console.error('renderTenantList error', err);
    tenantListEl.innerHTML = '<div style="color:#b91c1c">Error rendering list</div>';
  }
}

/* populate filter rooms (rooms that exist in data) */
function populateFilterRoom(){
  const present = Array.from(new Set(tenantData.map(t=>t.room).filter(Boolean))).sort();
  filterRoom.innerHTML = '<option value="">All Rooms</option>';
  present.forEach(r=> filterRoom.innerHTML += `<option value="${r}">${r}</option>`);
}

/* start edit: prefill Add form */
function startEdit(id){
  const t = tenantData.find(x => String(x.id) === String(id) || String(x.rowNum) === String(id));
  if(!t){ alert('Tenant not found'); return; }

  document.getElementById('name').value = t.name || '';
  document.getElementById('phone').value = t.phone || '';
  document.getElementById('moveIn').value = t.moveIn || '';
  document.getElementById('moveOut').value = t.moveOut || '';
  document.getElementById('rent').value = t.rent || '';
  document.getElementById('rentStatus').value = t.rentStatus || 'Pending';
  document.getElementById('room').value = t.room || '';
  document.getElementById('bed').value = t.bed || '';
  editIdInput.value = t.id || t.rowNum || '';

  formTitle.textContent = 'âœï¸ Edit Tenant';
  saveBtn.textContent = 'Update Tenant';

  showSection('add');
  formMsg.textContent = 'Editing â€” make changes and Save';
}

/* reset form */
function resetForm(){
  tenantForm.reset();
  editIdInput.value = '';
  formTitle.textContent = 'âž• Add Tenant';
  saveBtn.textContent = 'Save Tenant';
  formMsg.textContent = '';
}

/* Save (Add or Edit) */
tenantForm.addEventListener('submit', async (ev) => {
  ev.preventDefault();
  if(isSubmitting) return;
  isSubmitting = true;
  saveBtn.disabled = true;

  try{
    // refresh to validate
    await loadTenants();

    const payload = {
      name: document.getElementById('name').value.trim(),
      phone: document.getElementById('phone').value.trim(),
      moveIn: document.getElementById('moveIn').value || '',
      moveOut: document.getElementById('moveOut').value || '',
      rent: document.getElementById('rent').value || '',
      rentStatus: document.getElementById('rentStatus').value || 'Pending',
      room: document.getElementById('room').value,
      bed: document.getElementById('bed').value
    };

    if(!payload.name || !payload.phone || !payload.room || !payload.bed){
      formMsg.style.color = '#b91c1c';
      formMsg.textContent = 'Please fill required fields';
      return;
    }

    const editingId = editIdInput.value || null;
    // occupants excluding currently edited
    const occupants = tenantData.filter(t => t.room === payload.room && String(t.id) !== String(editingId)).length;
    if(occupants >= 4){
      formMsg.style.color = '#b91c1c';
      formMsg.textContent = 'Room already has 4 tenants';
      return;
    }

    const bedTaken = tenantData.some(t => t.room === payload.room && String(t.bed) === String(payload.bed) && String(t.id) !== String(editingId));
    if(bedTaken){
      formMsg.style.color = '#b91c1c';
      formMsg.textContent = 'Selected bed is already occupied';
      return;
    }

    if(editingId){
      // edit via POST to ?action=edit
      payload.id = editingId;
      await apiFetch('edit', { method:'POST', body: payload });
      formMsg.style.color = '#065f46';
      formMsg.textContent = 'Tenant updated';
    } else {
      // add via POST to ?action=add
      await apiFetch('add', { method:'POST', body: payload });
      formMsg.style.color = '#065f46';
      formMsg.textContent = 'Tenant added';
    }

    resetForm();
    await loadTenants();
    showSection('list');

  } catch(err){
    console.error('save error', err);
    formMsg.style.color = '#b91c1c';
    formMsg.textContent = 'Save failed â€” check deployment';
  } finally {
    isSubmitting = false;
    saveBtn.disabled = false;
    setTimeout(()=> formMsg.textContent = '', 2500);
  }
});

/* Soft delete using id (works whether id is RowId or row number) */
async function softDelete(id){
  if(!confirm('Mark tenant deleted? You can restore later.')) return;
  try{
    // call the delete endpoint with id query param
    await fetch(`${SCRIPT_URL}?action=delete&id=${encodeURIComponent(id)}`);
    // reload
    await loadTenants();
    formMsg.style.color = '#065f46';
    formMsg.textContent = 'Tenant marked deleted';
    setTimeout(()=> formMsg.textContent = '', 2000);
  } catch(err){
    console.error('delete error', err);
    formMsg.style.color = '#b91c1c';
    formMsg.textContent = 'Delete failed';
  }
}

/* Restore (only works if backend supports restore) */
async function restoreTenant(id){
  try{
    await fetch(`${SCRIPT_URL}?action=restore&id=${encodeURIComponent(id)}`);
    await loadTenants();
    formMsg.style.color = '#065f46';
    formMsg.textContent = 'Tenant restored';
    setTimeout(()=> formMsg.textContent = '', 2000);
  } catch(err){
    console.error('restore error', err);
    formMsg.style.color = '#b91c1c';
    formMsg.textContent = 'Restore failed or unsupported';
  }
}

/* small helpers */
function escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
searchInput.addEventListener('input', ()=>{ currentPage = 1; renderTenantList(); });
filterRoom.addEventListener('change', ()=>{ currentPage = 1; renderTenantList(); });
clearBtn.addEventListener('click', ()=> resetForm());

/* initial bootstrap: load tenants + dashboard */
(async function init(){
  try{ await loadTenants(); await loadDashboard(); } catch(e){ console.warn(e); }
})();

// expose for inline onclicks
window.startEdit = startEdit;
window.softDelete = softDelete;
window.restoreTenant = restoreTenant;
window.showSection = showSection;

</script>
</body>
</html>
