<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PG Tenant Management â€” Pro</title>
  <style>
    :root{
      --sidebar:#111827;
      --muted:#6b7280;
      --accent:#0a84ff;
      --card:#ffffff;
      --glass:#f8fafc;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:Inter,Arial,Helvetica,sans-serif;
      display:flex;
      min-height:100vh;
      background:#f3f4f6;
      color:#0f172a;
    }
    .sidebar{
      width:240px;
      background:var(--sidebar);
      color:white;
      padding:18px;
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .sidebar h1{font-size:18px;margin:0 0 8px 0}
    .sidebar button{
      background:#111827; color:#e5e7eb; border:1px solid rgba(255,255,255,0.04);
      padding:10px; border-radius:8px; cursor:pointer; text-align:left;
    }
    .sidebar button:hover{background:#0b1220}
    .content{flex:1;padding:20px}
    .card{background:var(--card); padding:16px; border-radius:10px; box-shadow:0 6px 18px rgba(15,23,42,0.06); margin-bottom:16px}
    form .row{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
    form label{display:block;margin:6px 0 4px;font-size:13px;color:var(--muted)}
    input[type=text], input[type=number], input[type=date], select{
      width:100%; padding:10px; border-radius:8px;border:1px solid #e6e7eb;
      background:#fff;font-size:14px;
    }
    form button[type=submit]{background:var(--accent); color:white;border:none;padding:10px 14px;border-radius:9px;cursor:pointer}
    .controls{display:flex; gap:12px; align-items:center; margin-bottom:12px}
    #listContainer > .item{display:flex; justify-content:space-between; gap:12px; padding:10px; border-radius:8px; background:var(--glass); margin-bottom:8px; align-items:center}
    #listContainer .meta{font-size:14px}
    .small-btn{padding:6px 8px;border-radius:8px;border:none;cursor:pointer}
    .small-btn.edit{background:#059669;color:white}
    .small-btn.remove{background:#ef4444;color:white}
    .badge{display:inline-block;padding:6px 8px;border-radius:999px;background:#eef2ff;color:#1e3a8a;font-size:13px;margin-right:6px}
    /* responsive */
    @media (max-width:900px){
      .sidebar{display:none}
      form .row{grid-template-columns:1fr}
    }
    /* dashboard canvas sizing */
    .chart-wrap{height:220px}
  </style>
</head>
<body>

  <aside class="sidebar">
    <h1>PG Manager</h1>
    <button id="btnAdd">âž• Add Tenant</button>
    <button id="btnShow">ðŸ“‹ Show Tenants</button>
    <button id="btnDashboard">ðŸ“Š Dashboard</button>
    <div style="margin-top:auto; font-size:13px; color:#a1a1aa">Note: Rooms fixed 101..106 / 201..206 .. 601..603</div>
  </aside>

  <main class="content">
    <!-- Add Form -->
    <section id="formSection" class="card">
      <h2 style="margin:0 0 12px 0">Add / Edit Tenant</h2>
      <form id="tenantForm" autocomplete="off">
        <input type="hidden" id="editRow" value="">
        <div class="row">
          <div>
            <label>Name</label>
            <input type="text" id="name" required placeholder="Full name" />
          </div>
          <div>
            <label>Phone</label>
            <input type="text" id="phone" required placeholder="Phone number" />
          </div>

          <div>
            <label>Move-in Date</label>
            <input type="date" id="movein" required />
          </div>
          <div>
            <label>Move-out Date</label>
            <input type="date" id="moveout" />
          </div>

          <div>
            <label>Monthly Rent (INR)</label>
            <input type="number" id="rent" required />
          </div>
          <div>
            <label>Rent Status</label>
            <select id="rentStatus">
              <option value="Pending">Pending</option>
              <option value="Paid">Paid</option>
            </select>
          </div>

          <div>
            <label>Room</label>
            <select id="room" required>
              <option value="">Select Room</option>
              <!-- rooms list -->
              <option>101</option><option>102</option><option>103</option><option>104</option><option>105</option><option>106</option>
              <option>201</option><option>202</option><option>203</option><option>204</option><option>205</option><option>206</option>
              <option>301</option><option>302</option><option>303</option><option>304</option><option>305</option><option>306</option>
              <option>401</option><option>402</option><option>403</option><option>404</option><option>405</option><option>406</option>
              <option>501</option><option>502</option><option>503</option><option>504</option><option>505</option><option>506</option>
              <option>601</option><option>602</option><option>603</option>
            </select>
          </div>
          <div>
            <label>Bed (1-4)</label>
            <select id="bed" required>
              <option value="1">Bed 1</option>
              <option value="2">Bed 2</option>
              <option value="3">Bed 3</option>
              <option value="4">Bed 4</option>
            </select>
          </div>
        </div>

        <div style="margin-top:12px; display:flex; gap:8px">
          <button type="submit" id="submitBtn">Save Tenant</button>
          <button type="button" id="cancelEdit" style="background:#f3f4f6;color:#111;padding:10px;border-radius:8px;border:1px solid #e6e7eb">Clear</button>
          <div id="formMsg" style="margin-left:12px; align-self:center; color:#065f46"></div>
        </div>
      </form>
    </section>

    <!-- List -->
    <section id="tenantListSection" class="card" style="display:none">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px">
        <h2 style="margin:0">Tenants</h2>
        <div class="controls">
          <input id="searchInput" placeholder="Search name/phone/room" style="padding:8px;border-radius:8px;border:1px solid #e6e7eb" />
          <select id="roomFilter" style="padding:8px;border-radius:8px;border:1px solid #e6e7eb">
            <option value="">All Rooms</option>
          </select>
        </div>
      </div>

      <div id="listContainer"></div>

      <div id="pagination" style="display:flex; gap:8px; margin-top:12px"></div>
    </section>

    <!-- Dashboard -->
    <section id="dashboardSection" class="card" style="display:none">
      <h2 style="margin:0 0 12px 0">Occupancy Dashboard</h2>
      <div style="display:grid; grid-template-columns:repeat(2,1fr); gap:14px">
        <div class="card chart-wrap" style="padding:12px">
          <h4 style="margin:0 0 8px 0">Floor Occupancy</h4>
          <canvas id="floorChart"></canvas>
        </div>
        <div class="card chart-wrap" style="padding:12px">
          <h4 style="margin:0 0 8px 0">Rent Paid vs Pending</h4>
          <canvas id="rentChart"></canvas>
        </div>
        <div class="card chart-wrap" style="padding:12px">
          <h4 style="margin:0 0 8px 0">Top Rooms</h4>
          <canvas id="roomChart"></canvas>
        </div>
        <div class="card" style="padding:12px">
          <h4 style="margin:0 0 8px 0">Available Beds</h4>
          <div id="bedsInfo" style="font-size:16px;margin-bottom:8px">Loading...</div>
          <div id="floorBadges" style="display:flex;gap:8px;flex-wrap:wrap"></div>
        </div>
      </div>
    </section>

  </main>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script>
  // =========== CONFIG ===========
  const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyeYacsS876b0w1-pytYjPgo7XUAfsnLpkFoFgmPiOQDX0KunscC0ts5O57cUIDQ3zStA/exec"; // <-- REPLACE after you deploy Apps Script

  // =========== ELEMENTS ===========
  const btnAdd = document.getElementById('btnAdd');
  const btnShow = document.getElementById('btnShow');
  const btnDashboard = document.getElementById('btnDashboard');

  const formSection = document.getElementById('formSection');
  const tenantListSection = document.getElementById('tenantListSection');
  const dashboardSection = document.getElementById('dashboardSection');

  const tenantForm = document.getElementById('tenantForm');
  const submitBtn = document.getElementById('submitBtn');
  const cancelEdit = document.getElementById('cancelEdit');
  const editRowInput = document.getElementById('editRow');
  const formMsg = document.getElementById('formMsg');

  const listContainer = document.getElementById('listContainer');
  const searchInput = document.getElementById('searchInput');
  const roomFilter = document.getElementById('roomFilter');
  const paginationEl = document.getElementById('pagination');

  // Charts
  let floorChart, rentChart, roomChart;

  // state
  let tenantData = []; // fresh data from server
  let currentPage = 1;
  const itemsPerPage = 6;
  let isSubmitting = false;

  // =========== NAV =============
  btnAdd.onclick = () => { showSection('form'); };
  btnShow.onclick = () => { showSection('list'); };
  btnDashboard.onclick = () => { showSection('dashboard'); };

  function showSection(which){
    if(which==='form'){
      formSection.style.display='block';
      tenantListSection.style.display='none';
      dashboardSection.style.display='none';
      formMsg.textContent = '';
    } else if(which==='list'){
      formSection.style.display='none';
      tenantListSection.style.display='block';
      dashboardSection.style.display='none';
      loadTenants();
    } else {
      formSection.style.display='none';
      tenantListSection.style.display='none';
      dashboardSection.style.display='block';
      loadDashboard();
    }
  }

  // init show add
  showSection('form');

  // =========== HELPERS =============
  function showToast(msg, success = true){
    formMsg.style.color = success ? '#065f46' : '#b91c1c';
    formMsg.textContent = msg;
    setTimeout(()=> formMsg.textContent = '', 3000);
  }

  // safe fetch wrapper
  async function apiFetch(path, opts){
    // path might include ?action=...
    const url = SCRIPT_URL + (path.startsWith('?') ? path : path);
    const res = await fetch(url, opts);
    if(!res.ok) throw new Error('Network response not ok');
    const txt = await res.text();
    // try parse JSON
    try { return JSON.parse(txt); } catch(e){ return txt; }
  }

  // =========== ADD / EDIT =============
  tenantForm.addEventListener('submit', async (ev) => {
    ev.preventDefault();
    if(isSubmitting) return;
    isSubmitting = true;
    submitBtn.disabled = true;

    try{
      // Ensure latest tenant list for validation
      await loadTenants();

      const name = document.getElementById('name').value.trim();
      const phone = document.getElementById('phone').value.trim();
      const movein = document.getElementById('movein').value;
      const moveout = document.getElementById('moveout').value;
      const rent = document.getElementById('rent').value;
      const rentStatus = document.getElementById('rentStatus').value;
      const room = document.getElementById('room').value;
      const bed = document.getElementById('bed').value;

      if(!name || !phone || !movein || !rent || !room || !bed){
        showToast('Please fill required fields', false);
        return;
      }

      // max 4 per room
      const occupants = tenantData.filter(t => t.room == room).length;
      // If we're editing and the edited record is in same room we should ignore that record in count
      const editingRow = editRowInput.value ? Number(editRowInput.value) : null;
      if(editingRow){
        const editing = tenantData.find(t => t._row === editingRow);
        if(editing && editing.room === room){
          // same record, occupants count should reduce by 1
        } else {
          // different or new room, count stands
        }
      }
      const effectiveOccupants = editingRow ? tenantData.filter(t=> t._row!==editingRow && t.room==room).length : occupants;
      if(effectiveOccupants >= 4){
        showToast('Room already has 4 tenants', false);
        return;
      }

      // bed availability
      const bedTaken = tenantData.some(t => t.room==room && t.bed==bed && t._row !== editingRow);
      if(bedTaken){
        showToast('Selected bed is already occupied', false);
        return;
      }

      // prepare body
      const body = new FormData();
      const editing = !!editingRow;
      body.append('name', name);
      body.append('phone', phone);
      body.append('moveIn', movein);
      body.append('moveOut', moveout);
      body.append('rent', rent);
      body.append('rentStatus', rentStatus);
      body.append('room', room);
      body.append('bed', bed);

      if(editing){
        body.append('id', editingRow);
        // POST to edit
        await apiFetch('?action=edit', { method:'POST', body });
        showToast('Tenant updated');
      } else {
        // POST to add
        await apiFetch('?action=add', { method:'POST', body });
        showToast('Tenant added');
      }

      // reset and refresh
      tenantForm.reset();
      editRowInput.value = '';
      await loadTenants();
      showSection('list');

    }catch(err){
      console.error(err);
      showToast('Failed to save â€” check deployment', false);
    } finally {
      isSubmitting=false;
      submitBtn.disabled=false;
    }
  });

  cancelEdit.onclick = () => {
    tenantForm.reset();
    editRowInput.value = '';
    showToast('Cleared', true);
  };

  // =========== LOAD TENANTS ============
  async function loadTenants(){
    try{
      // GET list
      const data = await apiFetch('?action=list');
      // expected an array
      tenantData = Array.isArray(data) ? data.map((r, idx) => {
        // unify field names and store server row as _row
        // server returns row as numeric row index (1-based)
        return {
          _row: Number(r.row || r._row || r.id || (idx+2)),
          name: r.name || r.Name || '',
          phone: r.phone || r.Phone || '',
          moveIn: r.moveIn || r.movein || r.MoveIn || '',
          moveOut: r.moveOut || r.moveout || r.MoveOut || '',
          rent: r.rent || r.Rent || '',
          rentStatus: r.rentStatus || r.RentStatus || r.rentStatus || 'Pending',
          bed: r.bed || r.Bed || '',
          room: r.room || r.Room || ''
        };
      }) : [];

      currentPage = 1;
      renderTenantList();
      populateRoomFilter();
      return tenantData;
    }catch(e){
      console.error(e);
      showToast('Failed to load tenants â€” check SCRIPT_URL', false);
      return [];
    }
  }

  // =========== RENDER LIST & PAGINATION ===========
  function renderTenantList(){
    const q = searchInput.value.trim().toLowerCase();
    const filterRoomVal = roomFilter.value;

    let filtered = tenantData.slice();

    if(filterRoomVal){
      filtered = filtered.filter(t => t.room == filterRoomVal);
    }
    if(q){
      filtered = filtered.filter(t =>
         (t.name || '').toLowerCase().includes(q) ||
         (t.phone || '').toLowerCase().includes(q) ||
         (t.room || '').toLowerCase().includes(q)
      );
    }

    const total = filtered.length;
    const pages = Math.max(1, Math.ceil(total / itemsPerPage));
    if(currentPage > pages) currentPage = pages;

    const start = (currentPage - 1) * itemsPerPage;
    const pageData = filtered.slice(start, start + itemsPerPage);

    listContainer.innerHTML = '';
    if(pageData.length === 0) {
      listContainer.innerHTML = '<div style="padding:12px;color:#6b7280">No tenants found</div>';
    }

    pageData.forEach(t => {
      const el = document.createElement('div');
      el.className = 'item';
      const left = document.createElement('div');
      left.className = 'meta';
      left.innerHTML = `<strong>${escapeHtml(t.name)}</strong><div style="font-size:13px;color:#6b7280">${escapeHtml(t.phone)} â€¢ Room ${escapeHtml(t.room)} â€¢ Bed ${escapeHtml(t.bed)}</div>`;
      const right = document.createElement('div');

      const editBtn = document.createElement('button');
      editBtn.className = 'small-btn edit';
      editBtn.textContent = 'Edit';
      editBtn.onclick = () => startEdit(t);

      const removeBtn = document.createElement('button');
      removeBtn.className = 'small-btn remove';
      removeBtn.textContent = 'Remove';
      removeBtn.onclick = () => {
        if(confirm('Remove this tenant?')) removeTenant(t._row);
      };

      right.appendChild(editBtn);
      right.appendChild(removeBtn);

      el.appendChild(left);
      el.appendChild(right);
      listContainer.appendChild(el);
    });

    // pagination
    paginationEl.innerHTML = '';
    for(let i=1;i<=pages;i++){
      const btn = document.createElement('button');
      btn.textContent = i;
      btn.style.padding = '6px 10px';
      btn.style.borderRadius = '6px';
      btn.style.border = '1px solid #e6e7eb';
      btn.style.background = i===currentPage ? '#0a84ff' : '#fff';
      btn.style.color = i===currentPage ? '#fff' : '#111';
      btn.onclick = () => { currentPage = i; renderTenantList(); };
      paginationEl.appendChild(btn);
    }
  }

  function startEdit(t){
    document.getElementById('name').value = t.name;
    document.getElementById('phone').value = t.phone;
    document.getElementById('movein').value = t.moveIn || '';
    document.getElementById('moveout').value = t.moveOut || '';
    document.getElementById('rent').value = t.rent || '';
    document.getElementById('rentStatus').value = t.rentStatus || 'Pending';
    document.getElementById('room').value = t.room;
    document.getElementById('bed').value = t.bed;
    editRowInput.value = t._row;
    showSection('form');
    showToast('Editing tenant (Save to apply)');
  }

  async function removeTenant(row){
    try{
      await apiFetch(`?action=delete&id=${row}`);
      await loadTenants();
      showToast('Removed');
    }catch(e){
      console.error(e);
      showToast('Failed to remove', false);
    }
  }

  // =========== SEARCH & FILTER EVENTS ===========
  searchInput.addEventListener('input', () => { currentPage = 1; renderTenantList(); });
  roomFilter.addEventListener('change', () => { currentPage = 1; renderTenantList(); });

  function populateRoomFilter(){
    const rooms = [...new Set(tenantData.map(t => t.room).filter(Boolean))].sort();
    roomFilter.innerHTML = '<option value="">All Rooms</option>';
    rooms.forEach(r => {
      const opt = document.createElement('option'); opt.value = r; opt.textContent = r; roomFilter.appendChild(opt);
    });
  }

  // =========== DASHBOARD ===========
  async function loadDashboard(){
    try{
      const data = await apiFetch('?action=dashboard');
      const floors = data.floors || {};
      const rooms = data.rooms || {};
      const rentStatus = data.rentStatus || {Paid:0,Pending:0};

      renderFloorChart(floors);
      renderRentChart(rentStatus);
      renderRoomChart(rooms);
      updateAvailableBeds(rooms);
    }catch(e){
      console.error(e);
      showToast('Failed to load dashboard', false);
    }
  }

  function renderFloorChart(floors){
    const labels = Object.keys(floors).sort();
    const values = labels.map(l => floors[l]);

    const ctx = document.getElementById('floorChart').getContext('2d');
    if(floorChart) floorChart.destroy();
    floorChart = new Chart(ctx, {
      type:'bar',
      data:{labels, datasets:[{label:'Tenants', data:values}]},
      options:{responsive:true, maintainAspectRatio:false}
    });
  }

  function renderRentChart(rentStatus){
    const labels = Object.keys(rentStatus);
    const values = labels.map(k => rentStatus[k]);

    const ctx = document.getElementById('rentChart').getContext('2d');
    if(rentChart) rentChart.destroy();
    rentChart = new Chart(ctx, {
      type:'pie',
      data:{labels, datasets:[{data:values}]},
      options:{responsive:true, maintainAspectRatio:false}
    });
  }

  function renderRoomChart(rooms){
    const entries = Object.entries(rooms).sort((a,b)=>b[1]-a[1]).slice(0,10);
    const labels = entries.map(e=>e[0]);
    const values = entries.map(e=>e[1]);

    const ctx = document.getElementById('roomChart').getContext('2d');
    if(roomChart) roomChart.destroy();
    roomChart = new Chart(ctx, {
      type:'bar',
      data:{labels, datasets:[{label:'Occupants', data:values}]},
      options:{responsive:true, maintainAspectRatio:false}
    });
  }

  function updateAvailableBeds(rooms){
    const allRooms = ['101','102','103','104','105','106','201','202','203','204','205','206','301','302','303','304','305','306','401','402','403','404','405','406','501','502','503','504','505','506','601','602','603'];
    const perRoom = 4;
    let total = 0;
    const floorMap = {};

    allRooms.forEach(r => {
      const occupied = rooms[r] || 0;
      const avail = Math.max(0, perRoom - occupied);
      total += avail;
      const f = r.toString()[0];
      floorMap[f] = (floorMap[f] || 0) + avail;
    });

    document.getElementById('bedsInfo').textContent = `${total} beds available across property.`;
    const badges = document.getElementById('floorBadges');
    badges.innerHTML = '';
    Object.keys(floorMap).sort().forEach(f => {
      const d = document.createElement('div');
      d.className = 'badge';
      d.textContent = `Floor ${f}: ${floorMap[f]} beds`;
      badges.appendChild(d);
    });
  }

  // small utility
  function escapeHtml(s){
    if(!s) return '';
    return s.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
  }

  // initial load of tenants to keep data ready
  loadTenants();

  </script>

</body>
</html>


